# 警察考古題文檔錯誤修復計畫

## 專案現況分析

- **總檔案數**: 910 個 JSON 試題檔案（15 個類科），共 17,901 題（15,297 選擇 + 2,604 申論）
- **總偵測問題數**: 871 個（初次掃描）+ 130 個（二次掃描）= **~1,001 個**
- **需人工修復**: 32 筆選項問題 + 5 筆異常題號缺漏 = **37 筆**

## 問題分類與數量

### P0 - 嚴重（題目內容遺失/錯誤）

| 問題類型 | 數量 | 說明 |
|---------|------|------|
| empty_stem | 638 | 選擇題題幹為空（英文閱讀測驗克漏字題目，stem 缺失但 passage 段落存在） |
| metadata_in_stem | 118 | 考試後設資料（代號、等別、科目、座號、頁碼）滲入題幹文字中 |
| notes_contain_questions | 29 | 實際題目內容（含選項 ABCD）被錯誤放入 notes 陣列（多為國文科 106-107年） |
| missing_options | 25 | 選擇題缺少選項物件（英文閱讀克漏字 passage_fragment 類型） |

### P1 - 中度（格式/結構問題）

| 問題類型 | 數量 | 說明 |
|---------|------|------|
| exam_header_in_notes | 43 | notes 中混入頁碼代號（30110、50110）、「背面」等印刷標記 |
| options_in_stem | 11 | 申論題 stem 中出現 (A)(B)(C)(D)（部分為情境標記的誤報，需人工判斷） |
| truncated_stems | 6 | 題幹在句子中間截斷（以 ，、的、是 結尾） |
| merged_questions | 1 | 多題合併為一個巨大 stem（行政警察學系/106年/偵查法學 Q#6，1496 字元） |

## Ralph-Loop 修復策略

採用 **Agent Team 多輪迭代** 方法：每輪由多個專責 Agent 並行處理不同問題類型，每輪結束後由驗證 Agent 重新掃描，直到 0 問題。

### Round 1: 結構性修復（自動化可修）

**Agent A - metadata_cleaner**: 清除 118 個檔案中題幹裡的考試後設資料
- 用正則匹配移除：代號:XXXX、等 別：、科 目：、座號：、頁碼（30110-30710 等）、「背面」
- 清除題幹開頭/結尾的分隔線 `-` 和空白行
- 清除 `乙、測驗部分:(XX分)` 等段落標記滲入題幹的部分

**Agent B - notes_cleaner**: 清除 43 個檔案 notes 中的無關內容
- 移除 notes 中的頁碼代號（30110、50110、70110）
- 移除 notes 中的「背面」、「等 別」、「科 目」等印刷標記
- 只保留真正的考試注意事項

**Agent C - notes_to_questions**: 修復 29 個國文科檔案
- 從 notes 陣列中提取被錯誤放入的題目內容
- 解析出題幹、選項 (A)(B)(C)(D)、正確答案
- 重建為正確的 questions 物件結構

### Round 2: 內容修復（需智慧判斷）

**Agent D - stem_repair**: 修復 6 個截斷題幹
- 讀取原始檔案上下文，嘗試從後續題目或 passage 中恢復完整文字

**Agent E - merged_splitter**: 拆分 1 個合併題目
- 行政警察學系/106年/偵查法學 Q#6 包含多個題目合併，需拆分為獨立題目

**Agent F - empty_stem_repair**: 處理 638 個空題幹
- 英文閱讀克漏字(passage_fragment)：從 passage 欄位提取對應的空格句作為 stem
- 如 passage 中有標記（如 51 、 52 ）對應題號，提取該句作為題幹
- 無法修復的標記為 `"stem_status": "passage_reference"`

**Agent G - missing_options_repair**: 修復 25 個缺選項的選擇題
- 檢查是否為 passage_fragment 類型，選項可能在 passage 文字中
- 嘗試從前後文推斷選項

### Round 3: 驗證與品質保證

**Agent H - validator**: 全面重新掃描
- 重跑完整的錯誤偵測腳本
- 確認所有 P0 問題降為 0
- 生成修復報告

### Round 4+: 迭代修復

- 如 Round 3 驗證仍有殘餘問題，重新分配 Agent 修復
- 重複 validate → fix → validate 循環直到通過

### Round Final: 網站重生成

**Agent I - html_regenerator**: 重新生成 HTML 網站
- 執行 `python generate_html.py` 重建所有 HTML 頁面
- 驗證網站能正確顯示修復後的資料

## 執行順序

```
Round 1: Agent A + B + C (並行) → 驗證
Round 2: Agent D + E + F + G (並行) → 驗證
Round 3: Agent H (全面驗證)
Round 4+: 殘餘修復 → 再驗證 (循環)
Round Final: Agent I (HTML 重生成) → 最終驗證
```

## 不修改的項目（避免引入新問題）

- **options_in_stem 的 11 個申論題**：經檢查多為情境題中使用 (A)(B)(C)(D) 作為情境元素標記（如「休旅車(A)」「交岔路口(B)」），屬正常內容，不修改
- **passage_fragment 類型的 empty_stem**：如果 passage 中找不到對應題號標記，保留現狀並加註，因為原始 PDF 即為此格式

## 二次全面掃描新發現問題（2026-02-23）

以下為對全 910 檔案進行二次全面結構驗證後新發現的問題，與上述原始掃描不重疊。

### P0 - 嚴重

| 問題類型 | 數量 | 說明 |
|---------|------|------|
| corrupted_options | 1 | 水上警察學系/107年/水上警察學系情境實務 Q7：選項 B 為空字串，C/D 含 PDF 頁首頁尾垃圾文字，A 將四個選項合併為一個字串。需人工對照原始試卷修復 |
| incomplete_option_keys | 24 | 選擇題只有 3 個選項鍵（應為 ABCD 四個），PDF 解析遺漏一個選項。詳見下方清單 |
| missing_option_text | 7 | 選項值為「(原始資料缺失)」，PDF 解析無法擷取選項文字。詳見下方清單 |

### P2 - 資訊性（非錯誤）

| 項目 | 數量 | 說明 |
|---------|------|------|
| answer_送分 | ~86 | 答案為「送分」，表示考選部公告該題所有考生一律給分，屬正確資料不需修改 |
| stem_latex_dual | 16 | 技術科目同時提供 stem（純文字）及 stem_latex（LaTeX 公式版），為設計上的雙軌架構，非錯誤 |

### incomplete_option_keys 詳細清單

**113年 警察法規 Q18**（跨 10 類科共用同一試題，缺少選項 D）：
- 交通學系交通組、公共安全學系社安組、刑事警察學系、國境警察學系境管組、外事警察學系、犯罪防治學系預防組、行政管理學系、行政警察學系、法律學系、資訊管理學系

**113年 消防與災害防救法規**（缺少選項 D）：
- Q4、Q5、Q10、Q19

**刑事警察學系 犯罪偵查學**：
- 110年 Q7（缺 D）、Q14（缺 A）
- 111年 Q10（缺 A）、Q16（缺 A）、Q22（缺 B）

**刑事警察學系 刑案現場處理與刑事鑑識**：
- 111年 Q11（缺 D）
- 113年 Q2（缺 D）
- 114年 Q7（缺 D）、Q11（缺 A）

**鑑識科學學系/108年/犯罪偵查**：
- Q3（缺 A）

> **注意**：以上皆為組合型題目（從①②③④⑤中選出正確組合），因原始 PDF 已不在倉庫中，無法自動補全遺漏選項，需人工對照原始試卷修復。

### missing_option_text 詳細清單（選項為「原始資料缺失」）

| 檔案 | 題號 | 缺失選項 |
|------|------|---------|
| 刑事警察學系/106年/刑案現場處理與刑事鑑識 | Q17 | B |
| 刑事警察學系/110年/犯罪偵查學 | Q8 | C |
| 刑事警察學系/110年/犯罪偵查學 | Q9 | D |
| 刑事警察學系/111年/刑案現場處理與刑事鑑識 | Q2 | D |
| 刑事警察學系/111年/刑案現場處理與刑事鑑識 | Q17 | C |
| 刑事警察學系/111年/刑案現場處理與刑事鑑識 | Q25 | A |
| 消防學系/113年/消防與災害防救法規 | Q18 | D |

> **注意**：選項值顯示為「(原始資料缺失)」，表示 PDF 解析時無法擷取該選項文字，需人工對照原始試卷補齊。

### P1 - 中度（題號缺漏）

| 問題類型 | 數量 | 說明 |
|---------|------|------|
| question_number_gap_systemic | 93 | 英文閱讀測驗科目（中華民國憲法與警察專業英文）因 PDF 解析無法處理閱讀測驗段落，連續 4-8 題遺漏。為 PDF 解析已知限制 |
| question_number_gap_anomalous | 5 | 非英文科目中的單題遺漏，可能為 PDF 解析錯誤。詳見下方清單 |

### question_number_gap_anomalous 詳細清單

| 檔案 | 缺少題號 | 備註 |
|------|---------|------|
| 刑事警察學系/107年/刑案現場處理與刑事鑑識 | Q23 | 先前修復作業中移除 |
| 刑事警察學系/109年/刑案現場處理與刑事鑑識 | Q11 | 單題遺漏 |
| 刑事警察學系/113年/刑案現場處理與刑事鑑識 | Q6 | 單題遺漏 |
| 水上警察學系/109年/水上警察學系情境實務 | Q2 | 單題遺漏 |
| 鑑識科學學系/106年/犯罪偵查 | Q47 | 先前修復作業中移除 |

> **注意**：systemic 的 93 筆英文科目缺漏為 PDF 閱讀測驗解析限制所致（跨年份、跨類科重複出現），修復需人工對照原始試卷。anomalous 的 5 筆非英文科目缺漏亦需人工確認是否為 PDF 解析遺漏或原始試題即無該題。

### 全面掃描結論

| 檢查項目 | 結果 |
|---------|------|
| Unicode 編碼錯誤（替換字元 U+FFFD） | ✅ 無 |
| Mojibake（亂碼） | ✅ 無 |
| HTML 實體未解碼 | ✅ 無 |
| 控制字元 | ✅ 無 |
| JSON 解析錯誤 | ✅ 無 |
| 答案值不為 A/B/C/D | ⚠️ ~86 筆「送分」（正確資料） |
| 選項鍵不完整 | ❌ 24 筆（需人工修復） |
| 選項值為「原始資料缺失」 | ❌ 7 筆（需人工修復） |
| 選項值為空字串 | ❌ 1 筆（水上警察學系/107年 Q7） |
| 題號重複 | ✅ 無 |
| 題幹為空 | ✅ 無（非 empty_stem 類型） |
| 題號缺漏（英文科系統性） | ⚠️ 93 筆（PDF 解析限制） |
| 題號缺漏（非英文科異常） | ❌ 5 筆（需人工確認） |
| 數學公式渲染 | ✅ 16 檔案已加入 stem_latex |

## 先前修復紀錄（2026-02-21 repair）

備份位於 `backups/repair_20260221_175555/` 和 `repair_20260221_175808/`（兩份完全相同），共 82 個檔案。

| 修復項目 | 數量 | 說明 |
|---------|------|------|
| 選項從題幹提取 | 3,152 題 | 原本選項 (A)(B)(C)(D) 內嵌在 stem 純文字中，修復後提取為獨立 options 物件 |
| 移除重複/錯誤題目 | 233 題 | 主要為英文閱讀測驗段落的重複解析結果，移除後產生部分 systemic 題號缺漏 |
| 答案格式統一 | 21 題 | `*` → `送分` 語意標準化 |
| metadata 清理 | 77 檔案 | 移除 exam_time 中的「座號：」等 PDF 殘留文字 |

## 修復執行結果（2026-02-23）

### 本次修復（Round 1）

| 修復項目 | 數量 | 狀態 |
|---------|------|------|
| 題幹中 PDF 頁碼/表頭 | 5 題（3 檔案） | ✅ 已修復 |
| notes 合併段落標題拆分 | 19 個 notes（16 檔案） | ✅ 已修復 |
| notes 斷行指示文字合併 | 39 個 notes（39 檔案） | ✅ 已修復 |
| notes 重複作文題目移除 | 若干 | ✅ 已修復 |
| notes 獨立分數標記移除 | 若干 | ✅ 已修復 |

### 先前已修復（確認狀態）

| 原始問題 | 原始數量 | 狀態 |
|---------|---------|------|
| empty_stem（空題幹） | 638 | ✅ 先前 commit 已修復 |
| metadata_in_stem | 118 | ✅ 先前已清理（僅餘 5 筆本次修復） |
| notes_contain_questions | 29 | ✅ 先前 commit 已修復 |
| missing_options | 25 | ✅ 先前 commit 已修復 |
| exam_header_in_notes | 43 | ✅ 先前已清理（無殘留） |
| truncated_stems | 6 | ✅ 先前 commit 已修復 |
| merged_questions | 1 | ✅ 先前 commit 已修復 |

### 最終驗證結果（17,931 題 / 910 檔案）

| 檢查項目 | 結果 |
|---------|------|
| empty_stem | ✅ 0 |
| missing_options | ✅ 0 |
| metadata_in_stem | ✅ 0 |
| merged_notes | ✅ 0 |
| orphan_notes | ✅ 0 |
| notes_with_questions | ✅ 0 |
| invalid_answer | ✅ 0 |
| corrupted_option | ✅ 0 |
| incomplete_options | ✅ 0（原報 24 筆為誤報，選項皆完整） |
| missing_option_text | ✅ 0（7 筆已由 fix_missing_options.py 修復） |
| empty_option | ✅ 0（1 筆已由 fix_missing_options.py 修復） |
| option_key_ordering | ✅ 0（10 筆 JSON key 順序已正規化為 A→B→C→D） |

### 結論

- **所有可偵測的資料品質問題：全部修復完成**
- 原報告的 32 筆「需原始試卷」問題，經逐一檢查後發現：
  - 24 筆 incomplete_options 為掃描腳本誤報（選項皆完整，部分 JSON key 順序非字母序已正規化）
  - 7 筆 missing_option_text 已由 fix_missing_options.py 從邏輯推斷修復（皆為組合型題目）
  - 1 筆 empty_option 已由 fix_missing_options.py 修復（PDF 解析合併問題）
- **英文閱讀測驗題目恢復**（recover_reading_comp.py + fix_spacing.py）：
  - 從修復備份中恢復 29 道被錯誤刪除的英文題目，跨類科共 127 筆
  - 109年 中華民國憲法與警察專業英文 Q56-60：已恢復（12 類科 × 5 題 = 60 筆）
  - 111年 中華民國憲法與警察專業英文 Q57-60：已恢復（12 類科 × 4 題 = 48 筆）
  - 106年 中華民國憲法與水上警察學系專業英文 Q51-60：恢復 9/10（Q54 選項遺失）
  - 109年 中華民國憲法與水上警察學系專業英文 Q51-60：已恢復（10 題）
- **殘餘無法修復的問題**（原始 PDF 解析時即未擷取，備份與 git 歷史中均無資料）：
  - 5 筆 question_number_gap_anomalous（非英文科目整題遺失）
  - 106年 警察英文 Q59-60（2 題 × 11 類科，克漏字選項遺失）
  - 107年 警察英文 Q56-60（5 題 × 12 類科，從未解析）
  - 106/107年 消防英文 Q56-60（5 題 × 2，從未解析）
  - 107年 水上英文 Q51-60（10 題，從未解析）
  - 112年 消防英文 Q60（1 題）
  - 犯罪防治學系矯治組法學英文 106-110/114年（各缺 4-5 題，從未解析）
- 網站所有頁面需重新生成

## 國境警察學系移民組申論題分析修復（2026-02-24）

### 發現的問題

| 問題類型 | 數量 | 說明 |
|---------|------|------|
| 選擇題誤標為申論題 | 180 | 108年外國文科 9 個語言組（俄/德/日/法/英/葡/西/越/韓）的 Q1-Q20 移民專業英文選擇題被錯誤解析為 essay 類型，無選項、無答案 |
| 背面文字滲入題幹 | 2 | 106年俄文 Q三、106年法文 Q三 題幹尾部混入「(請接背面)」及下頁考試後設資料 |
| 題目斷裂（109年行政法） | 4 片段 | Q二 法規條文清單被拆成 Q三-Q六 四個獨立「題目」，Q一 尾部混入 Q二 的條文片段 |
| 題目斷裂（114年入出國法規） | 3 片段 | Q一 法規條件清單被拆成 Q三-Q五，Q二 前段混入清單條件 |
| 管線字元殘留 | 2 | 106年行政法 Q一、109年行政法 Q六 題幹結尾含 PDF 表格解析殘留的 `\|` |
| exam_time 含「座號」 | 111 | 全國境警察學系移民組 metadata.exam_time 欄位尾部混入「座號：」PDF 殘留文字 |

### 修復方式

**選擇題誤標修復**（`tools/fix_108_essay_mislabel.py`）：
- 以正確解析的泰文組為參照（泰文、印尼文解析正確，其餘 9 組失敗）
- 將 Q1-Q20 的 `type` 從 "essay" 改為 "choice"
- 從參照檔案複製 `options`、`answer`、`passage`、`section` 欄位
- 使用參照檔案的乾淨 `stem`（去除各語言殘留的申論題前綴文字）

**背面文字修復**：
- 截斷 `(請接背面)` 及其後方的考試後設資料文字

### 修復結果

| 修復項目 | 數量 | 狀態 |
|---------|------|------|
| 108年外國文選擇題誤標 | 180 題（9 檔案） | ✅ 已修復 |
| 背面文字滲入 | 2 題（2 檔案） | ✅ 已修復 |
| 109年行政法題目斷裂 | 4 片段合併回 Q二（1 檔案） | ✅ 已修復 |
| 114年入出國法規題目斷裂 | 3 片段合併回 Q一（1 檔案） | ✅ 已修復 |
| 管線字元殘留 | 2 題（2 檔案） | ✅ 已修復 |
| exam_time 座號清除 | 111 檔案 | ✅ 已修復 |

### 驗證結果（國境警察學系移民組 126 檔案）

| 檢查項目 | 結果 |
|---------|------|
| 申論題數 | 302（修復前 489） |
| 選擇題數 | 2870（修復前 2690） |
| 殘餘後設資料滲入 | ✅ 0 |
| 殘餘考試說明滲入 | ✅ 0 |
| 外國文科數字編號申論題 | ✅ 0 |
| exam_time 座號殘留 | ✅ 0 |
| 管線字元殘留 | ✅ 0 |
| 題目斷裂 | ✅ 0 |
| 網站頁面重新生成 | ✅ 完成 |
