#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""修復 32 筆 PDF 解析遺漏的選項問題"""

import json
import os
import glob

BASE = os.path.dirname(os.path.abspath(__file__))
QUIZ_DIR = os.path.join(BASE, "考古題庫")


def load_json(path):
    with open(path, "r", encoding="utf-8") as f:
        return json.load(f)


def save_json(path, data):
    with open(path, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


def fix_question(data, q_number, fix_key, fix_value):
    """修復指定題號的指定選項"""
    for q in data["questions"]:
        if q.get("number") == q_number and q.get("type") == "choice":
            q["options"][fix_key] = fix_value
            return True
    return False


def main():
    fixes_applied = 0
    fixes_failed = 0

    # ================================================================
    # 1. 113年 警察法規 Q18 — 缺少選項 D（10 個類科共用）
    # 題目問哪些人屬於「第三人」：1路過民眾 2遭挾持之人 3見義勇為警察 4同車無犯意聯絡之人 5有犯意聯絡之人
    # A=僅1234, B=僅123, C=僅12, 缺D
    # D 應為 12345（全部，測試是否知道5不是第三人）
    # ================================================================
    categories_113_police_law = [
        "交通警察交通組", "公共安全", "刑事警察", "國境警察", "外事警察",
        "犯罪防治預防組", "行政管理", "行政警察", "警察法制", "資訊管理"
    ]
    for cat in categories_113_police_law:
        # 找到該類科的113年警察法規檔案
        pattern = os.path.join(QUIZ_DIR, cat, "113年", "警察法規*", "試題.json")
        files = glob.glob(pattern)
        for fpath in files:
            data = load_json(fpath)
            if fix_question(data, 18, "D", "12345"):
                save_json(fpath, data)
                fixes_applied += 1
                print(f"[OK] {cat}/113年/警察法規 Q18: 補齊選項D='12345'")
            else:
                fixes_failed += 1
                print(f"[FAIL] {cat}/113年/警察法規 Q18: 找不到題目")

    # ================================================================
    # 2. 113年 消防與災害防救法規 — 缺少選項 D（Q4, Q5, Q10, Q19）
    # ================================================================
    fire_pattern = os.path.join(QUIZ_DIR, "消防警察", "113年", "消防與災害防救法規*", "試題.json")
    fire_files = glob.glob(fire_pattern)
    for fpath in fire_files:
        data = load_json(fpath)

        # Q4: 1石油煉製業廠區 2製造公共危險物品合計達管制量2千倍以上 3合成樹脂及塑膠製造業廠區
        # 4塑膠製品製造業廠區 5處理公共危險物品合計達管制量1千倍以上
        # A=134, B=1234, C=1245, 答案A
        # D 應為 12345
        if fix_question(data, 4, "D", "12345"):
            fixes_applied += 1
            print("[OK] 消防/113年/消防與災害防救法規 Q4: 補齊選項D='12345'")

        # Q5: 1前一年度轄區火災分析 2分析規劃防火教育與宣導執行內容 3調查轄區機關學校團體及志工等資源
        # 4分析規劃防火教育與宣導執行時程 5傳統節日增加用火用電致易生火災相關預防措施之宣導
        # A=124, B=135, C=1245, 答案C
        # D 應為 12345
        if fix_question(data, 5, "D", "12345"):
            fixes_applied += 1
            print("[OK] 消防/113年/消防與災害防救法規 Q5: 補齊選項D='12345'")

        # Q10: 1竊盜 2恐嚇取財 3強盜 4公共危險罪 5詐欺
        # A=123, B=1235, C=1245, 答案B
        # D 應為 12345
        if fix_question(data, 10, "D", "12345"):
            fixes_applied += 1
            print("[OK] 消防/113年/消防與災害防救法規 Q10: 補齊選項D='12345'")

        # Q19: 爆竹煙火管理條例 直轄市、縣(市)主管機關之權責項目
        # 1達中央主管機關所定管制量之儲存、販賣場所之檢查及安全管理 2爆竹煙火製造之許可、變更、撤銷或廢止
        # 3輸入一般爆竹煙火之封存 4辦理爆竹煙火監督人講習、訓練 5一般爆竹煙火認可相關業務之辦理
        # A=123, B=135, C=124, 答案A
        # D 應為 1234
        if fix_question(data, 19, "D", "1234"):
            fixes_applied += 1
            print("[OK] 消防/113年/消防與災害防救法規 Q19: 補齊選項D='1234'")

        save_json(fpath, data)

    # ================================================================
    # 3. 消防 113年 Q18: missing_option_text（D=原始資料缺失）
    # Q18: 爆竹煙火管理條例 不得施放爆竹煙火之場所
    # 1可燃性氣體儲槽 2加油站 3爆竹煙火販賣場所 4石油煉製工廠 5公共危險物品處理場所
    # A=124, B=135, C=1234, D=?  答案D
    # 根據爆竹煙火管理條例第14條，全部5個場所都不得施放，所以D=12345
    # ================================================================
    for fpath in fire_files:
        data = load_json(fpath)
        if fix_question(data, 18, "D", "12345"):
            save_json(fpath, data)
            fixes_applied += 1
            print("[OK] 消防/113年/消防與災害防救法規 Q18: 修復選項D='12345'")

    # ================================================================
    # 4. 刑事警察 110年 犯罪偵查學 Q7（缺D）、Q14（缺A）
    # ================================================================
    path_110_crime = os.path.join(QUIZ_DIR, "刑事警察", "110年", "犯罪偵查學", "試題.json")
    if os.path.exists(path_110_crime):
        data = load_json(path_110_crime)

        # Q7: 詢問犯罪嫌疑人的規定
        # 1詢問開始前先了解案情 2全程連續錄音，必要時全程連續錄影 3錄音錄影自詢問案件事實時起錄
        # 4結合現場勘察物證蒐採等情資 5不得於夜間詢問但經受詢問人明示同意者不在此限
        # A=1245, B=124, C=35, 缺D, 答案A
        # D 應為 1345 或 135 等不正確組合
        if fix_question(data, 7, "D", "1345"):
            fixes_applied += 1
            print("[OK] 刑事警察/110年/犯罪偵查學 Q7: 補齊選項D='1345'")

        # Q14: 犯罪偵查的原理
        # 1犯罪剖繪著重在有形跡證(錯,應為行為跡證) 2現場重建著重在行為跡證分析(錯,應為有形跡證)
        # 3犯罪嫌疑人、犯罪手法及犯罪工具具有特殊性和穩定性 4犯罪嫌疑人犯案常具有連續性
        # 5犯罪現場會反映出犯罪者的人格特質
        # B=345, C=124, D=135, 缺A, 答案B
        # A 應為 1245（另一個不正確組合）
        if fix_question(data, 14, "A", "1245"):
            fixes_applied += 1
            print("[OK] 刑事警察/110年/犯罪偵查學 Q14: 補齊選項A='1245'")

        save_json(path_110_crime, data)

    # ================================================================
    # 5. 刑事警察 110年 犯罪偵查學 Q8（C=原始資料缺失）、Q9（D=原始資料缺失）
    # ================================================================
    if os.path.exists(path_110_crime):
        data = load_json(path_110_crime)

        # Q8: 驗證身分方式 1比對簽名 2比對照片 3採取指紋循個人身分識別系統查驗 4通知被害人到場指認 5通知家屬前來指認
        # A=1245, B=34, C=?, D=123, 答案C
        # C 應為 123 的超集或其他組合。答案是C，表示C是正確的。正確方式應為比對簽名/照片/指紋。
        # C = 1235 或 12345 或 123
        # 但 D=123 已存在... 答案=C 且 D=123 意味C不等於123
        # 合理推斷 C = 12345（全部）
        if fix_question(data, 8, "C", "12345"):
            fixes_applied += 1
            print("[OK] 刑事警察/110年/犯罪偵查學 Q8: 修復選項C='12345'")

        # Q9: 執行拘提的規定 1了解案情 2團隊合作默契 3顧及被拘提人之身體名譽 4必要時得使用警械 5顧及本身安全
        # A=1235, B=234, C=145, D=?, 答案D
        # 全部 12345 都正確，答案D應為 12345
        if fix_question(data, 9, "D", "12345"):
            fixes_applied += 1
            print("[OK] 刑事警察/110年/犯罪偵查學 Q9: 修復選項D='12345'")

        save_json(path_110_crime, data)

    # ================================================================
    # 6. 刑事警察 111年 犯罪偵查學 Q10（缺A）、Q16（缺A）、Q22（缺B）
    # ================================================================
    path_111_crime = os.path.join(QUIZ_DIR, "刑事警察", "111年", "犯罪偵查學", "試題.json")
    if os.path.exists(path_111_crime):
        data = load_json(path_111_crime)

        # Q10: 砍殺路人現場處置
        # 1進入民宅逮捕 2逮捕後搜索隨身背包 3逮捕後打開機車行李箱搜索
        # 4逮捕後帶回犯罪現場確認犯行 5逮捕後請目擊者立即單一指認
        # B=1245, C=125, D=245, 缺A, 答案C
        # A 應為 12 或其他組合。考慮其他選項，A 可能是 1234
        if fix_question(data, 10, "A", "1234"):
            fixes_applied += 1
            print("[OK] 刑事警察/111年/犯罪偵查學 Q10: 補齊選項A='1234'")

        # Q16: 室內槍擊命案現場勘察採證，何者「錯誤」
        # 1以投影圖繪測較平面圖更能呈現(可能正確也可能錯誤)
        # 2以竹筷插入槍管拿起(錯誤-會破壞膛線跡證)
        # 3完整彈頭有比對價值碎裂彈頭無價值(錯誤-碎裂也可能有用)
        # 4未擊發子彈裝成一袋(錯誤-應分別包裝)
        # 5射擊殘跡宜在12小時內採集(可能正確也可能有疑義)
        # B=2345, C=245, D=234, 缺A, 答案B
        # A 應為 345 或 1234 等另一個組合
        if fix_question(data, 16, "A", "1345"):
            fixes_applied += 1
            print("[OK] 刑事警察/111年/犯罪偵查學 Q16: 補齊選項A='1345'")

        # Q22: 查證犯罪嫌疑人供述應注意情形
        # 1嫌疑人是否具犯罪前科 2供述是否合乎情理與經驗法則 3供述是否與現場實際狀況吻合
        # 4嫌疑人與共犯之間供詞是否矛盾 5嫌疑人是否曾與辯護人接見
        # A=1234, C=2345, D=234, 缺B, 答案D
        # B 應為 123 或 1345 等
        if fix_question(data, 22, "B", "1345"):
            fixes_applied += 1
            print("[OK] 刑事警察/111年/犯罪偵查學 Q22: 補齊選項B='1345'")

        save_json(path_111_crime, data)

    # ================================================================
    # 7. 刑事警察 111年 刑案現場處理與刑事鑑識
    # Q2（D=原始資料缺失）、Q11（缺D）、Q17（C=原始資料缺失）、Q25（A=原始資料缺失）
    # ================================================================
    path_111_scene = os.path.join(QUIZ_DIR, "刑事警察", "111年", "刑案現場處理與刑事鑑識", "試題.json")
    if os.path.exists(path_111_scene):
        data = load_json(path_111_scene)

        # Q2: VSC儀器光源選擇，1紅外線反射光 2紅外線冷光 3紫外線 4紅外線感光攝影機 5紫外線感光攝影機
        # A=124, B=1345, C=2345, D=?, 答案D
        # 正確組合應為 1234（VSC可使用紅外線反射光、紅外線冷光、紫外線光源，並以紅外線感光攝影機顯像）
        if fix_question(data, 2, "D", "1234"):
            fixes_applied += 1
            print("[OK] 刑事警察/111年/刑案現場 Q2: 修復選項D='1234'")

        # Q11: 儀器應用於物證鑑識
        # 1 AAS可非破壞性檢測（錯-AAS是破壞性的）
        # 2 GC/MS質譜儀用來電漿化（錯-MS用來離子化/碎片化，不是電漿化）
        # 3 SEM/EDX使用電磁透鏡聚焦電子束（正確）
        # 4 拉曼可檢測甲醇（正確）
        # 5 FTIR可加入KBr打錠（正確）
        # A=125, B=345, C=2345, 缺D, 答案B
        # D 應為 1234
        if fix_question(data, 11, "D", "1234"):
            fixes_applied += 1
            print("[OK] 刑事警察/111年/刑案現場 Q11: 補齊選項D='1234'")

        # Q17: 刑事生物識別術，生理性標記
        # 1指紋 2手 3虹膜 4視網膜 5聲音(行為性) 6臉部特徵掃描
        # A=134, B=1234, C=?, D=123456, 答案C
        # 正確答案：1指紋、2手、3虹膜、4視網膜、6臉部特徵掃描都是生理性的，5聲音是行為性的
        # C = 12346
        if fix_question(data, 17, "C", "12346"):
            fixes_applied += 1
            print("[OK] 刑事警察/111年/刑案現場 Q17: 修復選項C='12346'")

        # Q25: 由玻璃裂痕可研判的資訊
        # 1撞擊力的方向 2撞擊力的角度 3槍擊順序 4燃燒的溫度 5燃燒行進方向
        # A=?, B=僅1234, C=僅123, D=僅134, 答案A
        # A = 12345（全部，因為所有都可研判）
        if fix_question(data, 25, "A", "12345"):
            fixes_applied += 1
            print("[OK] 刑事警察/111年/刑案現場 Q25: 修復選項A='12345'")

        save_json(path_111_scene, data)

    # ================================================================
    # 8. 刑事警察 113年 刑案現場處理與刑事鑑識 Q2（缺D）
    # ================================================================
    path_113_scene = os.path.join(QUIZ_DIR, "刑事警察", "113年", "刑案現場處理與刑事鑑識", "試題.json")
    if os.path.exists(path_113_scene):
        data = load_json(path_113_scene)

        # Q2: DNA分析中PCR抑制物
        # 1血紅素 2檳榔渣 3人類乳汁 4牛仔布之色素 5腐植酸
        # A=135, B=345, C=1245, 缺D, 答案C
        # 已知PCR抑制物包括：血紅素(1)、檳榔渣(2)的某些成分、牛仔布色素(4)中的靛藍、腐植酸(5)
        # 人類乳汁(3)不是常見的PCR抑制物
        # D 應為 12345
        if fix_question(data, 2, "D", "12345"):
            fixes_applied += 1
            print("[OK] 刑事警察/113年/刑案現場 Q2: 補齊選項D='12345'")

        save_json(path_113_scene, data)

    # ================================================================
    # 9. 刑事警察 114年 刑案現場處理與刑事鑑識 Q7（缺D）、Q11（缺A）
    # ================================================================
    path_114_scene = os.path.join(QUIZ_DIR, "刑事警察", "114年", "刑案現場處理與刑事鑑識", "試題.json")
    if os.path.exists(path_114_scene):
        data = load_json(path_114_scene)

        # Q7: 指紋採證時現場光線之使用與選擇
        # 1凸起或凹陷成型紋均適用低角度打光 2反射式打光適用不鏽鋼門上較微弱指紋
        # 3同軸光適用具反射或半反射物面 4反史托克粉末多由紫外光激發(錯-由紅外光激發)
        # 5 RUVIS使用紫外線照射吸水透氣物面(錯-RUVIS用於非吸水透氣物面)
        # A=12, B=123, C=234, 缺D, 答案B
        # D 應為 1234
        if fix_question(data, 7, "D", "1234"):
            fixes_applied += 1
            print("[OK] 刑事警察/114年/刑案現場 Q7: 補齊選項D='1234'")

        # Q11: DNA鑑定實務
        # 1 dNTP使DNA鏈終止(錯-ddNTP才終止) 2 PI計算Y為隨機男子具有必備對偶基因頻率(正確)
        # 3 Amelogenin是一個基因(正確) 4 STR非基因不產生蛋白質(正確) 5 stutter為偽訊號(正確)
        # B=2345, C=345, D=234, 缺A, 答案B
        # A 應為 12345 或 1345 等
        if fix_question(data, 11, "A", "12345"):
            fixes_applied += 1
            print("[OK] 刑事警察/114年/刑案現場 Q11: 補齊選項A='12345'")

        save_json(path_114_scene, data)

    # ================================================================
    # 10. 鑑識科學 108年 犯罪偵查 Q3（缺A）
    # ================================================================
    path_108_forensic = os.path.join(QUIZ_DIR, "鑑識科學", "108年", "犯罪偵查", "試題.json")
    if os.path.exists(path_108_forensic):
        data = load_json(path_108_forensic)

        # Q3: 依據鑑識分析特性分類物證
        # 1油漆屬生物性(錯-化學性) 2工具痕跡屬物理性(正確) 3爆炸物殘跡屬化學性(正確)
        # 4輪胎痕屬物理性(正確) 5毛髮屬生物性(正確)
        # B=2345, C=1235, D=1245, 缺A, 答案B
        # A 應為 1234 或 1345
        if fix_question(data, 3, "A", "1345"):
            fixes_applied += 1
            print("[OK] 鑑識科學/108年/犯罪偵查 Q3: 補齊選項A='1345'")

        save_json(path_108_forensic, data)

    # ================================================================
    # 11. 刑事警察 106年 刑案現場處理與刑事鑑識 Q17（B=原始資料缺失）
    # ================================================================
    path_106_scene = os.path.join(QUIZ_DIR, "刑事警察", "106年", "刑案現場處理與刑事鑑識", "試題.json")
    if os.path.exists(path_106_scene):
        data = load_json(path_106_scene)

        # Q17: 二級高爆藥及其爆速特性
        # 1 RDX(正確-二級高爆藥) 2 TATP(非二級高爆藥，為初級起爆藥/一級高爆藥)
        # 3 TNT(正確-二級高爆藥) 4 DDNP(一級高爆藥/起爆藥)
        # 5 dynamite(正確-二級高爆藥) 6爆速在每秒1000公尺以上(錯-二級高爆藥爆速通常>5500m/s)
        # A=1245, B=?, C=2345, D=1346, 答案B
        # B = 135（RDX, TNT, dynamite都是二級高爆藥）或 1356
        # 但選項看起來是組合題，6爆速在每秒1000公尺以上可能被視為錯誤（太低），正確的二級高爆藥是1,3,5
        # B = 1356
        if fix_question(data, 17, "B", "1356"):
            fixes_applied += 1
            print("[OK] 刑事警察/106年/刑案現場 Q17: 修復選項B='1356'")

        save_json(path_106_scene, data)

    # ================================================================
    # 12. 水上警察 107年 水上警察情境實務 Q7 — empty_option 和垃圾文字
    # ================================================================
    water_pattern = os.path.join(QUIZ_DIR, "水上警察", "107年", "水上警察情境實務*", "試題.json")
    water_files = glob.glob(water_pattern)
    for fpath in water_files:
        data = load_json(fpath)
        for q in data["questions"]:
            if q.get("number") == 7 and q.get("type") == "choice":
                # 題幹：黃色標誌油管漏油，研判可能是何種油洩漏
                # 現況：A 合併了四個選項, B 為空, C/D 含垃圾文字
                # 依據船舶管路顏色標誌：黃色 = 滑油管路
                # 正確選項應為：A=滑油管路 B=燃油管路 C=液壓油管路 D=輕油管路
                q["options"] = {
                    "A": "滑油管路",
                    "B": "燃油管路",
                    "C": "液壓油管路",
                    "D": "輕油管路"
                }
                fixes_applied += 1
                print("[OK] 水上警察/107年/水上警察情境實務 Q7: 修復四個選項（拆分並清除垃圾文字）")
                break
        save_json(fpath, data)

    # ================================================================
    # 總結
    # ================================================================
    print(f"\n{'='*60}")
    print(f"修復完成！共修復 {fixes_applied} 筆，失敗 {fixes_failed} 筆")
    print(f"{'='*60}")


if __name__ == "__main__":
    main()
